#!/bin/bash
{{- /* Script to install Docker daemon configuration */ -}}

set -e

echo "==> Configuring Docker daemon for deployment type: {{ .deploymentType }}"

{{- if .features.docker }}

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo "Warning: Docker is not installed. Skipping daemon configuration."
    exit 0
fi

# Create Docker daemon configuration directory
sudo mkdir -p /etc/docker

# Copy daemon configuration from chezmoi source
DAEMON_JSON="{{ .chezmoi.sourceDir }}/private_etc/docker/daemon.json"
if [ -f "${DAEMON_JSON}" ]; then
    echo "Installing Docker daemon configuration..."
    sudo cp "${DAEMON_JSON}" /etc/docker/daemon.json
    sudo chmod 644 /etc/docker/daemon.json
    
    # Reload and restart Docker daemon if systemd is available
    if command -v systemctl &> /dev/null; then
        if systemctl is-active --quiet docker; then
            echo "Restarting Docker daemon..."
            sudo systemctl daemon-reload
            sudo systemctl restart docker
            echo "Docker daemon restarted successfully"
        else
            echo "Docker service is not running. Configuration will apply on next start."
        fi
    else
        echo "systemctl not available. Please restart Docker manually."
    fi
else
    echo "Warning: daemon.json template not found at ${DAEMON_JSON}"
fi

{{- else }}
echo "Docker is not enabled for deployment type: {{ .deploymentType }}"
{{- end }}

echo "==> Docker daemon configuration complete!"
