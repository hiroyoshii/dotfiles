#!/bin/bash
{{- /* Enhanced setup script - installs tools if not already present */ -}}

set -e

echo "==> Running setup for deployment type: {{ .deploymentType }}"

# Helper function to check if command exists
command_exists() {
    command -v "$1" &> /dev/null
}

# Helper function to check if a version is installed
check_version() {
    local cmd=$1
    local version=$2
    if command_exists "$cmd"; then
        local installed_version=$($cmd version 2>&1 | grep -oP '\d+\.\d+\.\d+' | head -1)
        if [ -n "$installed_version" ]; then
            echo "  $cmd is already installed (version: $installed_version)"
            return 0
        fi
    fi
    return 1
}

{{- if .features.golang }}
# Install Go if not present
if ! command_exists go; then
    echo "Installing Go..."
    : "${GO_VERSION:=$(curl -s https://go.dev/VERSION?m=text | grep -oP '^go[0-9]+\.[0-9]+(\.[0-9]+)?') | sed 's/^go//')}"
    cd /tmp
    wget -q "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz"
    sudo rm -rf /usr/local/go
    sudo tar -C /usr/local -xzf "go${GO_VERSION}.linux-amd64.tar.gz"
    rm "go${GO_VERSION}.linux-amd64.tar.gz"
    # Add to PATH if not already there
    if ! grep -q "/usr/local/go/bin" ~/.bashrc; then
        echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
    fi
    if ! grep -q "~/go/bin" ~/.bashrc; then
        echo 'export PATH=$PATH:~/go/bin' >> ~/.bashrc
    fi
    export PATH=$PATH:/usr/local/go/bin:~/go/bin
    echo "  Go installed successfully"
else
    check_version go ""
fi

{{- end }}

{{- if .features.helm }}
# Install Helm if not present
if ! command_exists helm; then
    echo "Installing Helm..."
    cd /tmp
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    echo "  Helm installed successfully"
else
    check_version helm ""
fi
{{- end }}

{{- if .features.gcloud }}
# Install Google Cloud SDK if not present
if ! command_exists gcloud; then
    echo "Installing Google Cloud SDK..."
    if [ -f /etc/debian_version ]; then
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        sudo apt-get update && sudo apt-get install -y google-cloud-cli
        echo "  Google Cloud SDK installed successfully"
    else
        echo "  Warning: Automatic gcloud installation only supported on Debian/Ubuntu"
    fi
else
    check_version gcloud ""
fi
{{- end }}

echo "==> Setup complete!"
echo "Note: Some PATH changes may require restarting your shell or running 'source ~/.bashrc'"
