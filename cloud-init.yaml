#cloud-config
# Cloud-init configuration for deploying dotfiles with chezmoi
# Usage: Customize the environment variables and deploy to your cloud instance

# Set hostname
hostname: wsl-dev-machine

# Create users
users:
  - name: devuser
    groups: [sudo, docker]
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash

# Set timezone
timezone: UTC

# Package updates and installs
package_update: true
package_upgrade: true
packages:
  - curl
  - wget
  - git
  - vim
  - build-essential
  - ca-certificates
  - gnupg
  - lsb-release
  - software-properties-common

# Environment variables for chezmoi
# Customize these for your environment
write_files:
  - path: /etc/environment
    content: |
      DEPLOYMENT_TYPE=all
      PROXY_HOST=
      PROXY_PORT=8080
      NO_PROXY=localhost,127.0.0.1,.local
      GIT_USER_NAME=Your Name
      GIT_USER_EMAIL=your.email@example.com
    append: true

# Install and run chezmoi
runcmd:
  # Install Docker (if DEPLOYMENT_TYPE is all, edge, or cloud)
  - |
    DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-all}
    if [[ "$DEPLOYMENT_TYPE" == "all" || "$DEPLOYMENT_TYPE" == "edge" || "$DEPLOYMENT_TYPE" == "cloud" ]]; then
      # Add Docker's official GPG key
      install -m 0755 -d /etc/apt/keyrings
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg
      
      # Set up Docker repository
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      
      # Install Docker Engine
      apt-get update
      apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      
      # Add user to docker group
      usermod -aG docker devuser
      
      # Configure Docker proxy if set
      if [ -n "${PROXY_HOST}" ]; then
        mkdir -p /etc/systemd/system/docker.service.d
        cat > /etc/systemd/system/docker.service.d/http-proxy.conf <<EOF
      [Service]
      Environment="HTTP_PROXY=http://${PROXY_HOST}:${PROXY_PORT:-8080}"
      Environment="HTTPS_PROXY=http://${PROXY_HOST}:${PROXY_PORT:-8080}"
      Environment="NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,.local}"
      EOF
        systemctl daemon-reload
        systemctl restart docker
      fi
    fi

  # Install Go (if DEPLOYMENT_TYPE is all, edge, or cloud)
  - |
    DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-all}
    if [[ "$DEPLOYMENT_TYPE" == "all" || "$DEPLOYMENT_TYPE" == "edge" || "$DEPLOYMENT_TYPE" == "cloud" ]]; then
      GO_VERSION="1.21.5"
      wget -q "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz"
      rm -rf /usr/local/go
      tar -C /usr/local -xzf "go${GO_VERSION}.linux-amd64.tar.gz"
      rm "go${GO_VERSION}.linux-amd64.tar.gz"
    fi

  # Install Helm (if DEPLOYMENT_TYPE is all or cloud)
  - |
    DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-all}
    if [[ "$DEPLOYMENT_TYPE" == "all" || "$DEPLOYMENT_TYPE" == "cloud" ]]; then
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi

  # Install Google Cloud SDK (if DEPLOYMENT_TYPE is all or cloud)
  - |
    DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-all}
    if [[ "$DEPLOYMENT_TYPE" == "all" || "$DEPLOYMENT_TYPE" == "cloud" ]]; then
      echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
      curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
      apt-get update
      apt-get install -y google-cloud-cli
    fi

  # Install Ansible (if DEPLOYMENT_TYPE is all or onprem)
  - |
    DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-all}
    if [[ "$DEPLOYMENT_TYPE" == "all" || "$DEPLOYMENT_TYPE" == "onprem" ]]; then
      add-apt-repository -y ppa:ansible/ansible
      apt-get update
      apt-get install -y ansible
    fi

  # Install chezmoi
  - sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin
  
  # Run chezmoi init and apply for the user
  - |
    su - devuser -c "
      export DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-all}
      export PROXY_HOST=${PROXY_HOST}
      export PROXY_PORT=${PROXY_PORT:-8080}
      export NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,.local}
      export GIT_USER_NAME='${GIT_USER_NAME:-Your Name}'
      export GIT_USER_EMAIL='${GIT_USER_EMAIL:-your.email@example.com}'
      export PATH=\$PATH:/usr/local/go/bin:\$HOME/go/bin
      
      # Initialize chezmoi with your dotfiles repository
      chezmoi init --apply https://github.com/hiroyoshii/dotfiles.git
    "
  
  # Reload shell configuration
  - su - devuser -c "source ~/.bashrc"

# Final message
final_message: "Cloud-init complete. Dotfiles deployed via chezmoi. System ready for deployment type: $DEPLOYMENT_TYPE"
